# Правила архитектуры OpenClaw

Обязательные правила и паттерны для разработки в OpenClaw проекте.

## 1. Рабочие пространства агентов

### Структура

```
workspaces/{agent-id}/
├── SOUL.md          ← Личность, стиль, принципы
├── AGENTS.md        ← Роль, задачи, инструменты, инструкции
├── TOOLS.md         ← Конкретные API, URL, настройки
├── IDENTITY.md      ← Имя, эмодзи, первичная информация
├── USER.md          ← Info о пользователе (если есть)
├── HEARTBEAT.md     ← Периодические проверки (может быть пусто)
└── skills/          ← Локальные скилы (опционально)
    └── {skill}.md
```

### SOUL.md — Обязательное содержание

- **Личность**: кто вы, как вы думаете о себе
- **Стиль общения**: формальный/неформальный, язык (русский/англ), тон
- **Принципы**: что вы никогда не делаете, на чём стоите
- **Роль в системе**: как вы вписываетесь в экосистему
- Пример: Forex Trader отвечает по-русски, руководствуется строгими правилами риск-менеджмента, не торгует на новостях

### AGENTS.md — Обязательное содержание

- **Роль**: одно предложение что вы делаете
- **Основные задачи**: 3-5 bullet points
- **Используемые инструменты**: browser, image, web_search и т.д.
- **Типовые рабочие процессы**: step-by-step инструкции (e.g. "Шаг 1: Запустить браузер")
- **Стратегии**: если задача домена (торговля, разработка, тестирование)
- **Форматы отчётов**: как агент должен отчитываться
- **Периодические задачи**: если есть heartbeat
- Пример: Forex Trader описывает workflow MT5, стратегию Smart Money, формат сделок

### TOOLS.md — Обязательное содержание

- **API URL**: конкретные адреса (сокращённые для безопасности: `7467…umn4`)
- **Креденшалы**: только в safe-формате, реальные в `~/.openclaw/`
- **Настройки окружения**: часовые пояса, языки, параметры
- **Зависимости**: какие инструменты нужны на хосте (e.g. cliclick, screencapture)
- Пример: Forex Trader имеет FTMO WebTerminal URL, логин, часовые пояса торговли

## 2. Правила файлов и версионирования

### Именование файлов

- **Агенты**: `{agent-id}` нижний регистр, с дефисом (e.g. `forex-trader`)
- **Планы**: `<ID>-<short-title>.md` (e.g. `ASD-1440-forex-mt5-integration.md`)
- **Анализы**: `<ID>-<ANALYSIS-TYPE>.md` (e.g. `ASD-1440-risk-analysis.md`)
- **Формат**: всегда **Markdown** (`.md`)

### Версионирование

- Не перезаписывать файл план/анализ
- Если правка нужна — создать новый с суффиксом версии
- Пример: `ASD-1440-forex-mt5-v1.md` → `ASD-1440-forex-mt5-v2.md`
- В фронтматтере указывать `version: 1` (или 2, 3...)

### История изменений

- Каждый файл плана/анализа должен иметь в фронтматтере:
  ```yaml
  date: 2026-02-24
  last_updated: 2026-02-24
  version: 1
  status: draft | active | completed | archived
  ```

## 3. Правила создания планов и анализов

### План (когда создавать)

✓ Новый агент или расширение функционала агента
✓ Архитектурное изменение
✓ Интеграция нового инструмента (MT5, новый API и т.д.)
✓ Если сложная задача требует разбиения на шаги

✗ Не создавай план для простых правок (опечатки, небольшие улучшения)

### Анализ (когда создавать)

✓ Проверка архитектурного решения перед реализацией
✓ Выявление рисков и зависимостей
✓ Анализ требований сложной задачи
✓ Проверка совместимости с существующей системой

✗ Не создавай анализ для тривиальных изменений

### Структура плана (обязательные разделы)

```markdown
---
id: <ID>
date: <YYYY-MM-DD>
version: 1
status: draft
---

# План: <название>

## Цель

<одно предложение>

## Текущее состояние

<что есть сейчас>

## In Scope

- пункт

## Out of Scope

- пункт

## Шаги реализации

1. Шаг с верификацией
2. Шаг с верификацией

## DoD (Определение готовности)

- [ ] Критерий 1
- [ ] Критерий 2

## Риски

- Риск 1: описание, влияние, смягчение

## Открытые вопросы

1. Вопрос?

## Метаданные

- Требуемые агенты: <list>
- Требуемые tools: <list>
```

### Структура анализа (обязательные разделы)

```markdown
---
id: <ID>
date: <YYYY-MM-DD>
version: 1
type: risk-analysis | requirement-analysis | architecture-review
---

# Анализ: <название>

## Резюме

<2-3 предложения главный вывод>

## Предположения

- Предположение 1

## Риски

### Технические риски

- Риск 1: описание, влияние, вероятность

### Риски процесса

- Риск 1

## Открытые вопросы

1. Вопрос?

## Рекомендации

1. Рекомендация (приоритет: HIGH/MEDIUM/LOW)

## Скан согласованности

- Соответствие архитектуре: ✓/✗ <примечание>
- Конфликты с кодом: ✓/✗ <примечание>

## Метаданные

- Анализирован: <что>
- Версия архитектуры: <версия>
```

## 4. Правила для инструментов (tools)

### Browser Tool (для MT5, веб-интерфейсов)

✓ Используй для открытия WebTerminal
✓ Сначала `browser snapshot` (прочитать текстовое представление)
✓ Потом `browser screenshot` (для анализа графиков)
✓ `browser act` для взаимодействия (click, type)
✗ Не используй напрямую CSS-селекторы (только refs из snapshot)

### Image Tool (для анализа скриншотов)

✓ Вход: путь до скриншота
✓ Выход: описание что видно на скриншоте
✓ Используется вместе с browser screenshot для анализа графиков
✗ Не используй для текстового контента (используй browser snapshot)

### Web Tools (web_search, web_fetch)

✓ `web_search` для экономического календаря (перед торговлей)
✓ `web_fetch` для загрузки контента с URL
✗ Не используй для личных данных или защищённых ресурсов

### Exec Tool (bash команды)

✓ Для screencapture (снимок экрана)
✓ Для cliclick (управление мышью в macOS)
✓ Для проверки файлов, переменных окружения
✗ Не используй для системных операций (sudo, rm -rf и т.д.)
✗ Не коммитируй пароли в вывод команд

## 5. Правила безопасности

### Креденшалы

- ✗ Никогда не коммитить реальные пароли/токены в git
- ✓ Хранить в `~/.openclaw/openclaw.json` или env vars
- ✓ В текстовых файлах проекта (TOOLS.md): `7467…umn4` (скрыть большую часть)
- ✓ Комментарии типа "спросить у пользователя при первом подключении"

### Доступ

- ✓ Только разрешённые пути для каждого агента
- ✓ Sandbox mode OFF (если Docker недоступен)
- ✓ Проверять логи на ошибки безопасности: `tail -50 /tmp/openclaw/openclaw-*.log`

## 6. Правила Gateway и Telegram

### Gateway запуск

- Gateway должен быть в режиме `local` (только loopback)
- Портdefault: 18789
- Проверка: `openclaw status` → Gateway должен быть `reachable`

### Telegram бот

- Токен хранится в `~/.openclaw/openclaw.json` (`channels.telegram.token`)
- Пользователь указан в `channels.telegram.allowFrom` (e.g. `5929886678`)
- Проверка: `openclaw status --deep` → Telegram должен быть `OK`

### Тестирование

✓ `openclaw status` — быстрая проверка
✓ `openclaw status --deep` — полный аудит
✓ `openclaw agent --agent <id> --message "PING"` — тест агента напрямую
✓ `openclaw agent --agent <id> --message "test" --deliver` — тест доставки в Telegram

✗ Не тестировать на реальных данных без разрешения

## 7. Правила коммитов

### Git сообщения

```
docs: add plan <ID>-<title>        # Новый план
docs: add analysis <ID>-<title>    # Новый анализ
feat: add <agent> agent            # Новый агент
fix: update <agent> SOUL.md        # Обновление агента
chore: fix openclaw config         # Служебное
```

### Что коммитить

✓ Новые планы и анализы в .github/docs/
✓ Обновления SOUL.md, AGENTS.md, TOOLS.md
✓ Скрипты в scripts/
✓ Изменения openclaw.json

✗ Реальные креденшалы
✗ Логи в /tmp/openclaw/
✗ Временные файлы

## 8. Правила соответствия

### Все файлы должны соответствовать:

1. `.github/copilot-instructions.md` (основные правила проекта)
2. `.github/docs/protocols/task-envelope.md` (протокол создания планов/анализов)
3. `.github/docs/rules/architecture.md` (этот файл)

### При конфликте правил:

1. Пользователь (явное указание)
2. `.github/copilot-instructions.md` (основные правила)
3. `.github/docs/protocols/task-envelope.md` (протокол)
4. `.github/docs/rules/*` (специфические правила)

Если правила конфликтуют — спрашивай пользователя.
